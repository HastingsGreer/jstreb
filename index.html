<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./favicon.ico" />
    <title>Trebuchet Designer</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app">
      <div id="canvasHeader">
        <div id="headerControl">
          <div class="firstRow">
            <select id="presets" onchange="loadPreset(this)">
              <option>Presets</option>
            </select>

            <button onclick="doAnimate()">Play</button>
            <button id="optimize" onclick="optimizeRange()">Optimize</button>
            <button id="gentlify" onclick="optimize()">Gentlify</button>
            <button id="load" onclick="load()">Load</button>
            <button id="save" onclick="save()">Save</button>
          </div>
          <div class="headerRow">
            <label
              >Timestep
              <input
                id="timestep"
                type="text"
                oninput="data.timestep=+this.value;drawMechanism()"
            /></label>
            <label>
              Duration
              <input
                type="text"
                oninput="data.duration=+this.value;drawMechanism()"
                id="duration"
            /></label>
            <label>
              Main Axle
              <select
                id="mainaxle"
                onchange="data.mainaxle=+this.value;drawMechanism()"
              ></select
            ></label>
            <label>
              Projectile
              <select
                id="projectile"
                onchange="data.projectile=+this.value;drawMechanism()"
              ></select
            ></label>
            <label>
              Arm Tip
              <select
                id="armtip"
                onchange="data.armtip=+this.value;drawMechanism()"
              ></select
            ></label>
          </div>
          <div class="headerRow">
            <label>
              Main Axle Height
              <input
                id="axleheight"
                onchange="data.axleheight=+this.value;drawMechanism()"
                type="text"
            /></label>
            ft
            <b>
              Range:
              <span id="range"></span> ft
            </b>
            Peak force: <span id="peakLoad"></span> lbf Simtime:
            <span id="simtime"></span>
            <a href="https://www.hgreer.com/TrebuchetSimulator">Back to Blog</a>
          </div>
        </div>
        <canvas id="mechanism"></canvas>
      </div>
      <div id="allcontrols">
        <div id="particlesControl">
          <div class="firstRow">
            <button onclick="createParticle()">+ Particle</button>
          </div>
          <!-- Particle control boxes will be dynamically inserted here -->
        </div>
        <div id="constraintsControl">
          <div class="firstRow">
            <button onclick="createConstraint('rod')">+ Rod</button>
            <button onclick="createConstraint('slider')">+ Slider</button>
            <button onclick="createConstraint('colinear')">+ Roller</button>
            <button onclick="createConstraint('f2k')">+ F2k</button>
            <button onclick="createConstraint('rope')">+ Rope</button>
            <button onclick="createConstraint('pin')">+ Pin</button>
          </div>
          <!-- Constraint control boxes will be dynamically inserted here -->
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
<a href="#" id="plotLink">Plot Time Series</a>

    <div id="plotContainer" style="display:none; width:2000px; height:300px">
        <canvas id="myChart"></canvas>
    </div>

    <script>
function transpose(matrix) {
    return matrix[0].map((_, colIndex) => matrix.map(row => row[colIndex]));
}
        const plotLink = document.getElementById('plotLink');
        const plotContainer = document.getElementById('plotContainer');
        
        plotLink.onclick = function(e) {
            e.preventDefault();
            try {
                const data = transpose(window.forceLog.splice(1)) || [[1, 3, 4], [1, 2, 5], [1, 4, 5]];
                const times = window.constraintLog[0] || data[0].map((_, i) => i);  // Default to index if times not provided
                plotTimeSeries(data, times);
            } catch (error) {
                console.error("Error in onclick handler:", error);
                alert("An error occurred. Please check the console for details.");
            }
        };

        function plotTimeSeries(data, times) {
            try {
                plotContainer.style.display = 'block';
                
                const ctx = document.getElementById('myChart').getContext('2d');
                
                const datasets = data.map((series, index) => ({
                    label: `Series ${index + 1}`,
                    data: series.map((value, i) => ({x: times[i], y: value})),
                    borderColor: getRandomColor(),
                    fill: false
                }));

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Time Series Plot'
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: 'Time (seconds)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(2) + 's';
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Value'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error in plotTimeSeries:", error);
                alert("An error occurred while plotting. Please check the console for details.");
            }
        }

        function getRandomColor() {
            return '#' + Math.floor(Math.random()*16777215).toString(16);
        }
    </script>
    <script type="module" src="./interface.js"></script>
  </body>
</html>
